# Google Custom Search API Contract
#
# Purpose: Documents expected request/response format for web enrichment using Google Custom Search API.
# Used for testing and implementation reference.
#
# Feature: 003-people-profile-sync
# Created: 2026-01-29

api_version: "v1"
base_url: "https://www.googleapis.com/customsearch/v1"

authentication:
  method: "API Key"
  required_env_vars:
    - name: "GOOGLE_CUSTOM_SEARCH_API_KEY"
      description: "API key from Google Cloud Console"
      example: "AIza..."

    - name: "GOOGLE_SEARCH_ENGINE_ID"
      description: "Custom Search Engine ID (cx parameter)"
      example: "017576..."

rate_limits:
  free_tier: "100 queries per day"
  paid_tier: "10,000 queries per day"
  handling: "Cache results indefinitely to minimize API calls"

request:
  method: "GET"
  endpoint: "/v1"
  required_params:
    - name: "key"
      type: "string"
      description: "API key"
      source: "GOOGLE_CUSTOM_SEARCH_API_KEY"

    - name: "cx"
      type: "string"
      description: "Custom Search Engine ID"
      source: "GOOGLE_SEARCH_ENGINE_ID"

    - name: "q"
      type: "string"
      description: "Search query"
      max_length: 2048

  optional_params:
    - name: "num"
      type: "integer"
      description: "Number of results to return"
      default: 10
      max: 10

    - name: "start"
      type: "integer"
      description: "Index of first result (for pagination)"
      default: 1

  example_queries:
    # General position/affiliation search
    - query: "Kelly O'Donnell Stanford current position"
      purpose: "Find current professional information"

    # LinkedIn-specific search
    - query: "Kelly O'Donnell site:linkedin.com/in"
      purpose: "Find LinkedIn profile URL"

    # Contextual search with institution
    - query: "Kelly O'Donnell ecohydrology MIT"
      purpose: "Disambiguate using research keywords and institution"

response:
  status_codes:
    - code: 200
      description: "Success"

    - code: 400
      description: "Bad request (invalid query or parameters)"

    - code: 403
      description: "Quota exceeded or invalid API key"

    - code: 429
      description: "Rate limit exceeded"

  success_schema:
    type: "object"
    properties:
      - name: "items"
        type: "array"
        description: "List of search results"
        max_length: 10
        item_schema:
          type: "object"
          properties:
            - name: "title"
              type: "string"
              description: "Page title"
              example: "Kelly O'Donnell - Associate Professor - MIT"

            - name: "link"
              type: "string"
              format: "url"
              description: "URL of result"
              example: "https://eaps.mit.edu/people/kelly-odonnell"

            - name: "snippet"
              type: "string"
              description: "Text snippet from page"
              example: "Kelly O'Donnell is an Associate Professor of Earth Sciences at MIT, specializing in dryland ecohydrology..."

            - name: "displayLink"
              type: "string"
              description: "Display URL (domain)"
              example: "eaps.mit.edu"

      - name: "searchInformation"
        type: "object"
        properties:
          - name: "totalResults"
            type: "string"
            description: "Total number of results (may be approximate)"
            example: "12300"

  example_response:
    items:
      - title: "Kelly O'Donnell | MIT EAPS"
        link: "https://eaps.mit.edu/people/kelly-odonnell"
        snippet: "Kelly O'Donnell is an Associate Professor in the Department of Earth, Atmospheric and Planetary Sciences. Her research focuses on dryland ecohydrology and water resources in East Africa."
        displayLink: "eaps.mit.edu"

      - title: "Kelly O'Donnell - Google Scholar"
        link: "https://scholar.google.com/citations?user=..."
        snippet: "Kelly O'Donnell. Associate Professor, MIT. Verified email at mit.edu. Ecohydrology Remote Sensing Drylands. Articles Cited by."
        displayLink: "scholar.google.com"

      - title: "Kelly O'Donnell | LinkedIn"
        link: "https://www.linkedin.com/in/kellykodonnell"
        snippet: "Kelly O'Donnell · Associate Professor at MIT · Location: Cambridge, MA · 500+ connections on LinkedIn."
        displayLink: "linkedin.com"

    searchInformation:
      totalResults: "3450"

error_handling:
  - error: "Quota exceeded (403)"
    handling: "Use cached results if available; log warning; skip enrichment for this run"
    user_message: "Google Search API quota exceeded. Using cached results where available."

  - error: "Invalid API key (403)"
    handling: "Log error; skip enrichment; return empty suggestions"
    user_message: "Google Search API key is invalid or missing. Set GOOGLE_CUSTOM_SEARCH_API_KEY in .env file."

  - error: "Rate limit exceeded (429)"
    handling: "Wait and retry with exponential backoff (max 3 retries); fall back to cache"
    user_message: "Rate limited by Google Search API. Retrying..."

  - error: "Network timeout"
    handling: "Retry once; if fails, use cached results"
    user_message: "Network timeout connecting to Google Search API."

parsing_strategy:
  description: "Extract structured information from search results for enrichment"

  position_extraction:
    signals:
      - "Look for job titles in title field (e.g., 'Associate Professor', 'Research Scientist')"
      - "Parse snippet for phrases like 'is a [TITLE] at [INSTITUTION]'"
      - "Prioritize results from .edu domains or LinkedIn"

    patterns:
      - regex: "(?:is a|is an|works as|current position:?)\\s+([^,\\.]+?)\\s+(?:at|in|with)"
        capture: "position"

      - regex: "^(.+?)\\s*[-|]\\s*(.+?)\\s*[-|]\\s*(.+?)$"
        description: "Title format: 'Name - Position - Institution'"
        capture_group: 2

  institution_extraction:
    signals:
      - "Look for institution names in displayLink (e.g., 'mit.edu' → 'MIT')"
      - "Parse snippet for 'at [INSTITUTION]' or 'University of [NAME]'"

    patterns:
      - regex: "(?:at|in)\\s+((?:University of|MIT|Stanford|Harvard|[A-Z][a-z]+ (?:University|Institute|College))[^,\\.]*)"
        capture: "institution"

      - regex: "\\.edu domain → institution name mapping"
        examples:
          - "mit.edu → Massachusetts Institute of Technology"
          - "stanford.edu → Stanford University"
          - "ucsb.edu → University of California, Santa Barbara"

  linkedin_extraction:
    signals:
      - "Filter for results with link matching 'linkedin.com/in/'"
      - "Extract profile slug from URL"

    pattern:
      - regex: "linkedin\\.com/in/([a-zA-Z0-9-]+)"
        capture: "linkedin_profile_slug"
        full_url: "https://www.linkedin.com/in/{slug}"

  confidence_scoring:
    description: "Calculate confidence score based on result attributes"

    components:
      - name: "rank_score"
        weight: 0.4
        calculation: "1.0 for rank 1, linear decrease to 0.2 for rank 5+, 0.0 for rank 10+"

      - name: "name_match_score"
        weight: 0.3
        calculation: "Fuzzy string match between person name and result title (rapidfuzz ratio)"

      - name: "institution_match_score"
        weight: 0.2
        calculation: "1.0 if last known institution appears in result, 0.5 for partial match, 0.0 otherwise"

      - name: "context_score"
        weight: 0.1
        calculation: "Presence of research keywords, degree type, co-author names in snippet"

    threshold: 0.6
    action: "Only present suggestions with score >= 0.6 for manual review"

testing:
  mocking:
    library: "responses"
    description: "Mock HTTP requests to Google Custom Search API in tests"

  fixtures:
    - name: "kelly_odonnell_search_response.json"
      description: "Sample search results for 'Kelly O'Donnell current position'"
      use_case: "Test position/institution extraction from typical results"

    - name: "linkedin_search_response.json"
      description: "Sample results for 'Name site:linkedin.com/in'"
      use_case: "Test LinkedIn URL extraction"

    - name: "common_name_search_response.json"
      description: "Sample results for person with common name (e.g., 'John Smith')"
      use_case: "Test contextual disambiguation and confidence scoring"

  contract_tests:
    - test: "test_google_search_api_request_format"
      description: "Verify request includes required params (key, cx, q)"

    - test: "test_google_search_api_response_parsing"
      description: "Verify parsing of items array with title, link, snippet"

    - test: "test_google_search_api_position_extraction"
      description: "Verify extraction of job title from result title and snippet"

    - test: "test_google_search_api_institution_extraction"
      description: "Verify extraction of institution from displayLink and snippet"

    - test: "test_google_search_api_linkedin_extraction"
      description: "Verify extraction of LinkedIn profile URL"

    - test: "test_google_search_api_confidence_scoring"
      description: "Verify confidence score calculation matches expected algorithm"

    - test: "test_google_search_api_error_handling_quota_exceeded"
      description: "Verify graceful handling when quota is exceeded"

    - test: "test_google_search_api_error_handling_invalid_key"
      description: "Verify error message when API key is invalid"

graceful_degradation:
  description: "System must function without web enrichment if API unavailable"

  scenarios:
    - condition: "API key not set in .env"
      behavior: "Skip enrichment step; log info message; continue with CV sync only"

    - condition: "Quota exceeded"
      behavior: "Use cached results; log warning; skip uncached profiles"

    - condition: "Network error"
      behavior: "Retry once; if fails, skip enrichment for this run"

  user_guidance:
    missing_key: |
      Web enrichment is disabled because GOOGLE_CUSTOM_SEARCH_API_KEY is not set.
      To enable enrichment:
      1. Create a Google Custom Search Engine at https://cse.google.com
      2. Get an API key from Google Cloud Console
      3. Add to .env file:
         GOOGLE_CUSTOM_SEARCH_API_KEY=your_key_here
         GOOGLE_SEARCH_ENGINE_ID=your_cx_here

    quota_exceeded: |
      Google Search API quota exceeded (100 queries/day for free tier).
      Using cached enrichment results where available.
      To increase quota, upgrade at https://console.cloud.google.com
